worker_processes 1;
error_log /usr/local/openresty/nginx/logs/error.log warn;

events {
    worker_connections 1024;
}

http {
    resolver 8.8.8.8 8.8.4.4 ipv6=off;
    
    lua_shared_dict api_cache 10m;
    lua_package_path "/usr/local/openresty/nginx/lua/?.lua;/usr/local/openresty/lualib/?.lua;;";
    lua_package_cpath "/usr/local/openresty/lualib/?.so;;";
    
    server {
        listen 8080;
        
        location / {
            root /usr/local/openresty/nginx/html;
            index index.html;
            try_files $uri $uri/ /index.html;
        }
        
        location /health {
            content_by_lua_block {
                ngx.header.content_type = "application/json"
                ngx.say('{"status":"ok"}')
            }
        }
        
        location /api/weather/current {
            content_by_lua_file /usr/local/openresty/nginx/lua/api/current.lua;
        }
        
        location /api/weather/forecast {
            content_by_lua_file /usr/local/openresty/nginx/lua/api/forecast.lua;
        }
        
        location /api/weather/compare {
            content_by_lua_file /usr/local/openresty/nginx/lua/api/compare.lua;
        }
        
        location /api/weather/aggregate {
            content_by_lua_file /usr/local/openresty/nginx/lua/api/aggregate.lua;
        }
    }
}